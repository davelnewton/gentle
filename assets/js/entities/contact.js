// Generated by CoffeeScript 1.6.3
ContactManager.module('Entities', function(Entities, ContactManager, Backbone, Marionette, $, _) {
  var API, initializeContacts;
  Entities.Contact = Backbone.Model.extend({
    urlRoot: 'contacts'
  });
  Entities.configureStorage(Entities.Contact);
  Entities.ContactCollection = Backbone.Collection.extend({
    url: 'contacts',
    model: Entities.Contact,
    comparator: function(c) {
      return "" + (c.get('firstName')) + " " + (c.get('lastName'));
    }
  });
  Entities.configureStorage(Entities.ContactCollection);
  initializeContacts = function() {
    var contacts;
    console.log('DBG Entering initializeContacts...');
    contacts = new Entities.ContactCollection([
      {
        id: 1,
        firstName: "Alice",
        lastName: "Arten",
        phoneNumber: "555-0184"
      }, {
        id: 2,
        firstName: "Bob",
        lastName: "Brigham",
        phoneNumber: "555-0163"
      }, {
        id: 3,
        firstName: "Charlie",
        lastName: "Campbell",
        phoneNumber: "555-0129"
      }
    ]);
    contacts.forEach(function(contact) {
      return contact.save();
    });
    return contacts.models;
  };
  API = {
    getContactEntities: function() {
      var contacts, defer, promise;
      console.log('DBG Entering API#getContactEntities...');
      defer = $.Deferred();
      contacts = new Entities.ContactCollection();
      contacts.fetch({
        success: function(data) {
          console.log('DBG   Fetched; resolving data', data);
          return defer.resolve(data);
        }
      });
      promise = defer.promise();
      $.when(promise).done(function(contacts) {
        var models;
        console.log('DBG   Done fetching contacts...');
        if (contacts.length === 0) {
          console.log('DBG   No contacts; initializing...');
          models = initializeContacts();
          return contacts.reset(models);
        }
      });
      return promise;
    },
    getContactEntity: function(id) {
      var contact, defer, fetchFunc;
      console.log("DBG Entering API#getContactEntity(" + id + ")...");
      defer = $.Deferred();
      contact = new Entities.Contact({
        id: id
      });
      fetchFunc = function() {
        return contact.fetch({
          success: function(data) {
            return defer.resolve(data);
          },
          error: function(data) {
            return defer.resolve(void 0);
          }
        });
      };
      setTimeout(fetchFunc, 2000);
      return defer.promise();
    }
  };
  ContactManager.reqres.setHandler('contact:entities', function() {
    console.log("DBG ContactManager contact:entities...");
    return API.getContactEntities();
  });
  return ContactManager.reqres.setHandler('contact:entity', function(id) {
    console.log("DBG ContactManager contact:entity id=" + id + "...");
    return API.getContactEntity(id);
  });
});
